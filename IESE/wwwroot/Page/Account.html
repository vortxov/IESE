<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Account</title>
    <link href="../css/style.css" rel="stylesheet" />
</head>
<body>
    <header class="header">
        <a class="logo" href="#">
            <img class="logo__img" src="../images/ikon.png" alt="Logo" />
        </a>
        <h1 class="header__title">
            Электронная информационная образовательная система УГГУ
        </h1>

        <ul id="menu" class="menu">
        </ul>



        <div id="errors"></div>
        <form name="userForm" class="authorize__panel">
            <div class="user__div">
                <label class="label__user" for="email">Email:</label>
                <input class="input__user" placeholder="Email" name="email" />
            </div>
            <div class="user__div">
                <label class="label__user" for="password">Password:</label>
                <input class="input__user" placeholder="Password" name="password" type="password" />
            </div>
            <div>
                <button class="user__button" type="submit" id="submit">Войти</button>
            </div>
        </form>
    </header>

    <script src="../js/Main.js"></script>
    <script>

        var referrer_url = document.referrer; //Заносим в переменную прошлую ссылку
        async function Login(userEmail, userPassword, rememberMe) { //Функция входа в аккаунт

            const response = await fetch("/account", { //Отправляем запрос с данными который ввел пользователь
                method: "POST",
                headers: { "Accept": "application/json", "Content-Type": "application/json" },
                body: JSON.stringify({ // в json отправляем майл пароль и статическую переменную не запоминать акканут(так как еще не работает запоминание)
                    email: userEmail,
                    password: userPassword,
                    rememberme: true 
                })
            });
            if (response.ok === true) {
                const a = document.createElement('a');//Если вешел до делаем переход в прошлую ссылку    //TODO:проверка ссылки
                a.setAttribute('href', referrer_url);
                a.click();
            }
            else { //Если не вошел показываем ошибку
                const errorData = await response.json();
                document.getElementById("errors").innerHTML = '';
                if (errorData.errors) {
                    if (errorData.errors["Email"]) { //Если проблема в майле то показываем ошибку с майлом
                        addError(errorData.errors["Email"]);
                    }
                    if (errorData.errors["Password"]) {
                        addError(errorData.errors["Password"]);
                    }
                }
                if (errorData) {
                    if (errorData["Email"]) {
                        addError(errorData["Email"]);
                    }

                }

                document.getElementById("errors").style.display = "block"; //Делаем строку ошибки видимой
            }
        }

        function addError(errors) {//Функция для добавление в строку ошибки описание ошибки

            errors.forEach(error => { //Через цикл, так как ошибок может быть несколько
                const p = document.createElement("p");
                p.append(error);

                document.getElementById("errors").append(p);  //Находим строку для ошибок и добавляем описание
            });
        }



        document.forms["userForm"].addEventListener("submit", e => { //Создаем ивень при нажатие на кнопку с id submit 
            e.preventDefault();
            const form = document.forms["userForm"]; //Находим форму userForm 
            const email = form.elements["email"].value; //В эту форму находим элемент email и значение в этом элементе заносим в переменную
            const password = form.elements["password"].value; //В эту форму находим элемент password и значение в этом элементе заносим в переменную

            Login(email, password, true); //Вызываем функцию для авторизации и передаем переменные

        });




        async function GetAuthorize() { //Функция для настройки менюшки начальной
            role = await CheckAuthorizeRole();
            if (role != null) {
                window.location.href = '/index.html';
            }


            let rows = document.getElementById("menu");
            let liMain = document.createElement("li");
            liMain.setAttribute("class", "menu__item");
            let mainA = document.createElement("a");
            mainA.append("Главная");
            mainA.setAttribute("href", "/index.html")
            mainA.setAttribute("class", "menu__link link__outside link__animation");
            liMain.append(mainA);
            rows.append(liMain);

            let liAuthorize = document.createElement("li");
            liAuthorize.setAttribute("class", "menu__item");
            let authorizeA = document.createElement("a");
            authorizeA.append("Авторизация");
            authorizeA.setAttribute("href", "#")
            authorizeA.setAttribute("class", "menu__link link__inside");
            liAuthorize.append(authorizeA);
            rows.append(liAuthorize);

            let liFAQ = document.createElement("li");
            liFAQ.setAttribute("class", "menu__item");
            let FAQa = document.createElement("a");
            FAQa.append("FAQ");
            FAQa.setAttribute("href", "#")
            FAQa.setAttribute("class", "menu__link link__outside link__animation");
            liFAQ.append(FAQa);
            rows.append(liFAQ);

        }
        var role;

        GetAuthorize();
    </script>
</body>
</html>