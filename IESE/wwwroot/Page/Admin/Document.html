<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Document</title>
    <link href="../../css/style.css" rel="stylesheet" />
    <link href="../../ckeditor/sample/styles.css" rel="stylesheet" />
</head>
<body data-editor="DecoupledDocumentEditor" data-collaboration="false" data-revision-history="false">
    <!--<header class="header">-->
    <nav class="top-menu">
        <ul class="menu-main">
            <li><a href="/index.html">Главная</a></li>
            <li><a href="/Page/PersonalAccount.html">Личный Кабинет</a></li>
            <li><a href="#">FAQ</a></li>
        </ul>
    </nav>

    <div class="admincategory">

        <center><h3 class="title__category2">Создание нового документа:</h3></center>
        
        <table class="checkboxs" cellpadding="4" cellspacing="1">
            <tr><th><p><input type="checkbox" id="Студент" name="Студент" value="Студент">Студент</p></th><th><p><input type="checkbox" id="Преподаватель-Студент" name="a" value="Преподаватель-Студент" checked>Студент-преподаватель</p></th><th><p><input type="checkbox" id="Преподаватель" name="a" value="Преподаватель" checked>Преподаватель</p></th></tr>
        </table>


        <form class="menu__input" name="userForm">

            <input type="hidden" name="id" value="0" />

            <div class="row__input">
                <label for="name">Название документа:</label>
                <left><div id="errors" class="error"></div></left>
                <input class="menu__input__item" placeholder="Введите название будущего документа" name="name" />
            </div>

            <div class="">
                <button type="submit" id="submit" class="btn__menu__input">Сохранить</button>
                <a id="reset" class="btn__menu__input">Сбросить</a>
            </div>


            <nav class="pechat">

                <ul class="topmenu">
                    <li>
                        <a class="active">Печати<span class="fa fa-angle-down"></span></a>
                        <ul class="submenu">
                            <li>


                                <a class="pechat1">Отдел Кадров<span class="fa fa-angle-down"></span></a>
                                <ul class="submenu">

                                    <div class="vertical-menu1">
                                        <img src="../../images/pechat.bmp" />
                                        <img src="../../images/pechat.bmp" />
                                        <img src="../../images/pechat.bmp" />
                                    </div>

                                </ul>
                            </li>
                            <li>
                                <a>Деканат<span class="fa fa-angle-down"></span></a>
                                <ul class="submenu">

                                    <div class="vertical-menu1">
                                        <img src="../../images/pechat.bmp" />
                                        <img src="../../images/pechat.bmp" />
                                        <img src="../../images/pechat.bmp" />
                                    </div>

                                </ul>
                            </li>

                        </ul>
                    </li>

                </ul>
            </nav>



        </form>
    </div>

    <!--</header>-->



    <main>

        <div class="centered">

            <div class="row">
                <div class="document-editor__toolbar"></div>
            </div>

            <div class="row row-editor">
                <div class="vertical-menu">
                    <lbody>

                    </lbody>
                </div>
                <div class="editor-container">
                    <div class="editor">

                    </div>
                </div>
            </div>
        </div>

    </main>

    <script src="../../js/Main.js"></script>
    <script src="../../ckeditor/build/ckeditor.js"></script>
    <script>

        var myEditor = null;

        //ClassicEditor
        // .create(document.querySelector('#editor'), {

        // licenseKey: '',
        // //plugins: [ExportWord],
        // // toolbar: [
        // // 'exportWord', '|',
        // // ],
        // exportWord: {
        // stylesheets: [
        // 'EDITOR_STYLES',
        // './styles/format.css'
        // ],
        // fileName: 'my-document.docx',
        // converterOptions: {
        // // Document format settings with proper margins.
        // format: 'Letter',
        // margin_top: '19mm',
        // margin_bottom: '19mm',
        // margin_right: '19mm',
        // margin_left: '19mm',
        // }
        // }

        // })
        // .then(editor => {
        // myEditor = editor;

        // })
        // .catch(error => {
        // console.error('Oops, something went wrong!');
        // console.error(error);
        // });

        DecoupledDocumentEditor
            .create(document.querySelector('.editor'), {

                licenseKey: '',

                //exportWord: {
                // stylesheets: [
                // 'EDITOR_STYLES',
                // './styles/format.css'
                // ],
                // fileName: 'my-document.docx',
                // converterOptions: {
                // // Document format settings with proper margins.
                // format: 'Letter',
                // margin_top: '19mm',
                // margin_bottom: '19mm',
                // margin_right: '19mm',
                // margin_left: '19mm',
                // }
                //}

            })
            .then(editor => {
                myEditor = editor;

                // Set a custom container for the toolbar.
                document.querySelector('.document-editor__toolbar').appendChild(editor.ui.view.toolbar.element);
                document.querySelector('.ck-toolbar').classList.add('ck-reset_all');
            })
            .catch(error => {
                console.error(error);
            });

        document.addEventListener("reset", (event) => {
            var button = event.target;
            // if (event.target.type === 'button' && event.target.className.includes('testtokenbutton')) {

            myEditor.model.change(writer => {
                const insertPosition = myEditor.model.document.selection.getFirstPosition();

                writer.insertText("Text", insertPosition);
            });

            // }
        });

        async function GetDocuments() { //Запрос для заполнения таблицы списком документов
            const response = await fetch("/admindocument/category/" + categoryId, {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const documents = await response.json();
                let rows = document.querySelector("abody");
                documents.forEach(item => {
                    rows.append(row(item));
                });

            }
        }
        async function GetDocument(id) { //Запрос для получение одного документа по его id
            const response = await fetch("/admindocument/" + id, {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const itemDocument = await response.json();
                const form = document.forms["userForm"];
                form.elements["id"].value = itemDocument.id;
                form.elements["name"].value = itemDocument.title;
            }
        }

        async function GetTemplates() { //Запрос для получения списка всех возможных шаблонов
            const response = await fetch("/admindocument/templates", {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const itemTemplates = await response.json();
                let rows = document.querySelector("lbody");

                itemTemplates.forEach(item => {

                    var templatesButton = document.createElement("a");
                    templatesButton.setAttribute("data-id", item.id);
                    templatesButton.setAttribute("class", "table__link");
                    templatesButton.text = item.name;
                    templatesButton.addEventListener("click", e => {
                        var button = event.target;
                        // // if (event.target.type === 'button' && event.target.className.includes('testtokenbutton')) {

                        myEditor.model.change(writer => {
                            const insertPosition = myEditor.model.document.selection.getFirstPosition();

                            writer.insertText(item.template, insertPosition);
                        });

                        //}
                    });

                    rows.append(templatesButton);
                });
            }
        }

        async function CreateDocument(data) { //Запрос создания документа

            const response = await fetch("/admindocument", {
                method: "POST",
                body: data,
            });
            if (response.ok === true) {
                const category = await response.json();
                document.querySelector("tbody").append(row(category));
                reset();
            }
            else { //TODO: дописать ошибки для создания документа
                //const errorData = await response.json();
                //document.getElementById("errors").innerHTML = '';
                //if (errorData.errors) {
                // if (errorData.errors["Email"]) {
                // addError(errorData.errors["Email"]);
                // }
                // if (errorData.errors["Password"]) {
                // addError(errorData.errors["Password"]);
                // }
                //}
                //if (errorData) {
                // if (errorData["Email"]) {
                // addError(errorData["Email"]);
                // }

                //}

                document.getElementById("errors").style.display = "block";
            }
        }

        async function EditDocument(data) { //Запрос изменения документа в бд
            const response = await fetch("/admindocument", {
                method: "PUT",
                body: data
            });
            if (response.ok === true) {
                const item = await response.json();
                reset();
                document.querySelector("tr[document-rowid='" + item.id + "']").replaceWith(row(item));
            }
        }
        async function DeleteDocument(id) { //Запрос удаления документа из бд
            const response = await fetch("/admindocument/" + id, {
                method: "DELETE",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const item = await response.json();
                cher = document.querySelector("tr");
                document.querySelector("tr[document-rowid='" + item + "']").remove();

            }
        }

        function reset() { //Функция очистки формы где вносится название файла сам файл и тд
            const form = document.forms["userForm"];
            form.reset();
            form.elements["id"].value = 0;
        }

        function row(item) { //Создание строки которая вносится в таблицу
            const tr = document.createElement("tr");
            tr.setAttribute("document-rowid", item.id);

            const nameTd = document.createElement("td");
            nameTd.append(item.title);
            nameTd.setAttribute("class", "table__firstitem table__row");
            tr.append(nameTd);

            const linksTd = document.createElement("td");

            const editLink = document.createElement("a");
            editLink.setAttribute("data-id", item.id);
            editLink.setAttribute("class", "table__link");
            editLink.setAttribute("style", "cursor:pointer;padding:15px;");
            editLink.append("Изменить");
            editLink.addEventListener("click", e => {

                e.preventDefault();
                GetDocument(item.id);
            });
            linksTd.append(editLink);

            const removeLink = document.createElement("a");
            removeLink.setAttribute("data-id", item.id);
            removeLink.setAttribute("class", "table__link");
            removeLink.setAttribute("style", "cursor:pointer;padding:15px;");
            removeLink.append("Удалить");
            removeLink.addEventListener("click", e => {

                e.preventDefault();
                DeleteDocument(item.id);
            });
            linksTd.setAttribute("class", "table__seconditem table__row");
            linksTd.append(removeLink);
            tr.appendChild(linksTd);

            return tr;
        }

        function addErrors(errors) { //Функция добавляет в строку ошибки лист ошибок которые были допущены
            errors.forEach(error => {
                const p = document.createElement("p");
                p.append(error);
                document.getElementById("errors").append(p);
            });
        }

        function addError(errors) { //Функция добавление одной ошибки
            document.getElementById("errors").innerHTML = '';
            document.getElementById("errors").append(errors);
            document.getElementById("errors").style.display = "block";
        }

        document.getElementById("reset").onclick = function (e) { //Ищет кнопку обновление и при клике запускает функцию обновление формы

            e.preventDefault();
            reset();
        };

        document.forms["userForm"].addEventListener("submit", e => { //Создаем ивент для кнопки сохранить и пишем для нее фунцию сохранения
            e.preventDefault();
            const form = document.forms["userForm"]; //Получаем форму
            const id = form.elements["id"].value; //Получаем айди значение id(Если мы собираемся изменить файл, то оно не будет равно 0)
            const title = form.elements["name"].value; //Получаем название файла
            //var myfile = form.elements["uploadedFile"].files; //Получаем фалй который внес модератор
            var data = new FormData(); //Создаем класс в который занесутся все данные об файле

            //if (myfile.length > 0) { //Если размер файла больше 0
            // for (var i = 0; i < myfile.length; i++) {
            // data.append('uploadedFile', myfile[i]); //Добавляем все файлы в список для файлом
            // }
            //}
            var result = myEditor.getData({ pagination: true });

            data.append('uploadedFile', result);
            data.append('Title', title); //Добавляем название файла
            data.append('IdCategory', categoryId); //Добавляем id категории в которую занесется файл

            //const templates = []; //Создаем пустой лист для шаблонов

            //var l = document.querySelector("abody").children;
            //for (let i = 0; i < l.length; i++) {
            // if (l[i].type == "checkbox") {
            // if (l[i].checked)
            // templates.push(l[i].id); //добавляем в лист те шаблоны которые помечены модератором
            // }
            //}
            //data.append('Templates', templates); //Добавляем лист шаблонов в класс для хранения

            const roles = [];

            var st = document.querySelector("#Студент")
            if (st.checked) {
                roles.push(st.value)
            }
            var pt = document.querySelector("#Преподаватель")
            if (pt.checked) {
                roles.push(pt.value)
            }
            var ptst = document.querySelector("#Преподаватель-Студент")
            if (ptst.checked) {
                roles.push(ptst.value)
            }

            data.append('RoleDocument', roles);

            if (title == "") { //TODO: Сделать красивые ошибки
                addError("ПУСТОЕ ПОЛЕ ВВОДА") //Если название пусто то отобразит ошибку
            }
            //else if (myfile.length == 0) {
            // addError("Не выбран файл") //Если количество файло равно 0 то отобразит ошибку
            //}
            else {

                if (id == 0) //Если id равно 0 то создаем новый файл в бд
                    CreateDocument(data);
                else {
                    data.append('Id', id); //Если id чему то равно то добавляем id в класс для хранения
                    EditDocument(data); //Изменяем файл к бд
                }
            }
        });

        async function CheckRole() {
            var role = await CheckAuthorizeRole();
            if (role != "admin" && role != "otdelcadrov") {
                const a = document.createElement('a');
                a.setAttribute('href', "/index.html");
                a.click();
            }
        }
        CheckRole();

        var categoryId = window.location.href.split("?")[1].split("=")[1]; //Получаем id категории

        //GetDocuments(); //Вызываем функцию для получения списков документов
        GetTemplates(); //Вызываем функцию для получения списка шаблонов

    </script>
</body>
</html>