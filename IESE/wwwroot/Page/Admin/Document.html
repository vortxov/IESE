<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Document</title>
    <link href="../../css/style.css" rel="stylesheet" />
    <link href="../../ckeditor/sample/styles.css" rel="stylesheet" />
</head>
<body data-editor="DecoupledDocumentEditor" data-collaboration="false" data-revision-history="false">
    <!--<header class="header">-->
        <nav class="top-menu">
            <ul class="menu-main">
                <li><a href="AdminHome.html">Главная</a></li>
            </ul>
        </nav>
        <div class="admincategory">
            <h4>Документы</h4>
            <div id="errors" class="error" style="display:none;"></div>
            <form class="menu__input" name="userForm">

                <input type="hidden" name="id" value="0" />

                <div class="row__input">
                    <label for="name">Название документа:</label>
                    <input class="menu__input__item" placeholder="Название документа" name="name" />
                </div>

                <div class="input__checkboxmenu">
                    <abody>
                    </abody>
                </div>

                <div class="">
                    <button type="submit" id="submit" class="btn__menu__input">Сохранить</button>
                    <a id="reset" class="btn__menu__input">Сбросить</a>
                </div>
            </form>
        </div>
        
    <!--</header>-->
   
    <main >
        <div class="centered">
            <div class="row">
                <div class="document-editor__toolbar"></div>
            </div>
            <div class="row row-editor">
                <div class="editor-container">
                    <div class="editor">
                        <h2>Bilingual Personality Disorder</h2>
                        <figure class="image image-style-side">
                            <img src="https://c.cksource.com/a/1/img/docs/sample-image-bilingual-personality-disorder.jpg">
                            <figcaption>One language, one person.</figcaption>
                        </figure>
                        <p>
                            This may be the first time you hear about this made-up disorder but
                            it actually isn’t so far from the truth. Even the studies that were conducted almost half a century show that
                            <strong>the language you speak has more effects on you than you realise</strong>.
                        </p>
                        <p>
                            One of the very first experiments conducted on this topic dates back to 1964.
                            <a href="https://www.researchgate.net/publication/9440038_Language_and_TAT_content_in_bilinguals">In the experiment</a>
                            designed by linguist Ervin-Tripp who is an authority expert in psycholinguistic and sociolinguistic studies,
                            adults who are bilingual in English in French were showed series of pictures and were asked to create 3-minute stories.
                            In the end participants emphasized drastically different dynamics for stories in English and French.
                        </p>
                        <p>
                            Another ground-breaking experiment which included bilingual Japanese women married to American men in San Francisco were
                            asked to complete sentences. The goal of the experiment was to investigate whether or not human feelings and thoughts
                            are expressed differently in <strong>different language mindsets</strong>.
                            Here is a sample from the the experiment:
                        </p>
                        <table>
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>English</th>
                                    <th>Japanese</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Real friends should</td>
                                    <td>Be very frank</td>
                                    <td>Help each other</td>
                                </tr>
                                <tr>
                                    <td>I will probably become</td>
                                    <td>A teacher</td>
                                    <td>A housewife</td>
                                </tr>
                                <tr>
                                    <td>When there is a conflict with family</td>
                                    <td>I do what I want</td>
                                    <td>It's a time of great unhappiness</td>
                                </tr>
                            </tbody>
                        </table>
                        <p>
                            More recent <a href="https://books.google.pl/books?id=1LMhWGHGkRUC">studies</a> show, the language a person speaks affects
                            their cognition, behaviour, emotions and hence <strong>their personality</strong>.
                            This shouldn’t come as a surprise
                            <a href="https://en.wikipedia.org/wiki/Lateralization_of_brain_function">since we already know</a> that different regions
                            of the brain become more active depending on the person’s activity at hand. Since structure, information and especially
                            <strong>the culture</strong> of languages varies substantially and the language a person speaks is an essential element of daily life.
                        </p>
                    </div>
                </div>
            </div> 
        </div>
        <div>
            <lbody>

            </lbody>
        </div>
    </main>




    <script src="../../js/Main.js"></script>
    <script src="../../ckeditor/build/ckeditor.js"></script>
    <script>

        var myEditor = null;


        //ClassicEditor
        //    .create(document.querySelector('#editor'), {

        //        licenseKey: '',
        //        //plugins: [ExportWord],
        //      //  toolbar: [
        //      //      'exportWord', '|',
        //       // ],
        //        exportWord: {
        //            stylesheets: [
        //                'EDITOR_STYLES',
        //                './styles/format.css'
        //            ],
        //            fileName: 'my-document.docx',
        //            converterOptions: {
        //                // Document format settings with proper margins.
        //                format: 'Letter',
        //                margin_top: '19mm',
        //                margin_bottom: '19mm',
        //                margin_right: '19mm',
        //                margin_left: '19mm',
        //            }
        //        }


        //    })
        //    .then(editor => {
        //        myEditor = editor;




        //    })
        //    .catch(error => {
        //        console.error('Oops, something went wrong!');
        //        console.error(error);
        //    });

        DecoupledDocumentEditor
            .create(document.querySelector('.editor'), {

                licenseKey: '',

                //exportWord: {
                //    stylesheets: [
                //        'EDITOR_STYLES',
                //        './styles/format.css'
                //    ],
                //    fileName: 'my-document.docx',
                //    converterOptions: {
                //        // Document format settings with proper margins.
                //        format: 'Letter',
                //        margin_top: '19mm',
                //        margin_bottom: '19mm',
                //        margin_right: '19mm',
                //        margin_left: '19mm',
                //    }
                //}

            })
            .then(editor => {
                myEditor = editor;

                // Set a custom container for the toolbar.
                document.querySelector('.document-editor__toolbar').appendChild(editor.ui.view.toolbar.element);
                document.querySelector('.ck-toolbar').classList.add('ck-reset_all');
            })
            .catch(error => {
                console.error(error);
            });


        document.addEventListener("reset", (event) => {
            var button = event.target;
            //   if (event.target.type === 'button' && event.target.className.includes('testtokenbutton')) {

            myEditor.model.change(writer => {
                const insertPosition = myEditor.model.document.selection.getFirstPosition();

                writer.insertText("Text", insertPosition);
            });

            //  }
        });

        async function GetDocuments() { //Запрос для заполнения таблицы списком документов
            const response = await fetch("/admindocument/category/" + categoryId, {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const documents = await response.json();
                let rows = document.querySelector("abody");
                documents.forEach(item => {
                    rows.append(row(item));
                });

            }
        }
        async function GetDocument(id) { //Запрос для получение одного документа по его id
            const response = await fetch("/admindocument/" + id, {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const itemDocument = await response.json();
                const form = document.forms["userForm"];
                form.elements["id"].value = itemDocument.id;
                form.elements["name"].value = itemDocument.title;
            }
        }

        async function GetTemplates() { //Запрос для получения списка всех возможных шаблонов
            const response = await fetch("/admindocument/templates", {
                method: "GET",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const itemTemplates = await response.json();
                let rows = document.querySelector("lbody");

                itemTemplates.forEach(item => {

                    var templatesButton = document.createElement("a");
                    templatesButton.setAttribute("data-id", item.id);
                    templatesButton.setAttribute("class", "table__link");
                    templatesButton.text(item.name);
                    templatesButton.addEventListener("click", e => {
                        var button = event.target;
                        //   if (event.target.type === 'button' && event.target.className.includes('testtokenbutton')) {

                        myEditor.model.change(writer => {
                            const insertPosition = myEditor.model.document.selection.getFirstPosition();

                            writer.insertText(item.template, insertPosition);
                        });

            //  }
                    });

                    rows.append(templatesButton);
                });
            }
        }

        async function CreateDocument(data) { //Запрос создания документа

            const response = await fetch("/admindocument", {
                method: "POST",
                body: data,
            });
            if (response.ok === true) {
                const category = await response.json();
                document.querySelector("tbody").append(row(category));
                reset();
            }
            else { //TODO: дописать ошибки для создания документа
                //const errorData = await response.json();
                //document.getElementById("errors").innerHTML = '';
                //if (errorData.errors) {
                //    if (errorData.errors["Email"]) {
                //        addError(errorData.errors["Email"]);
                //    }
                //    if (errorData.errors["Password"]) {
                //        addError(errorData.errors["Password"]);
                //    }
                //}
                //if (errorData) {
                //    if (errorData["Email"]) {
                //        addError(errorData["Email"]);
                //    }

                //}

                document.getElementById("errors").style.display = "block";
            }
        }

        async function EditDocument(data) { //Запрос изменения документа в бд
            const response = await fetch("/admindocument", {
                method: "PUT",
                body: data
            });
            if (response.ok === true) {
                const item = await response.json();
                reset();
                document.querySelector("tr[document-rowid='" + item.id + "']").replaceWith(row(item));
            }
        }
        async function DeleteDocument(id) { //Запрос удаления документа из бд
            const response = await fetch("/admindocument/" + id, {
                method: "DELETE",
                headers: { "Accept": "application/json" }
            });
            if (response.ok === true) {
                const item = await response.json();
                cher = document.querySelector("tr");
                document.querySelector("tr[document-rowid='" + item + "']").remove();

            }
        }

        function reset() { //Функция очистки формы где вносится название файла сам файл и тд
            const form = document.forms["userForm"];
            form.reset();
            form.elements["id"].value = 0;
        }


        function row(item) { //Создание строки которая вносится в таблицу
            const tr = document.createElement("tr");
            tr.setAttribute("document-rowid", item.id);

            const nameTd = document.createElement("td");
            nameTd.append(item.title);
            nameTd.setAttribute("class", "table__firstitem table__row");
            tr.append(nameTd);

            const linksTd = document.createElement("td");

            const editLink = document.createElement("a");
            editLink.setAttribute("data-id", item.id);
            editLink.setAttribute("class", "table__link");
            editLink.setAttribute("style", "cursor:pointer;padding:15px;");
            editLink.append("Изменить");
            editLink.addEventListener("click", e => {

                e.preventDefault();
                GetDocument(item.id);
            });
            linksTd.append(editLink);

            const removeLink = document.createElement("a");
            removeLink.setAttribute("data-id", item.id);
            removeLink.setAttribute("class", "table__link");
            removeLink.setAttribute("style", "cursor:pointer;padding:15px;");
            removeLink.append("Удалить");
            removeLink.addEventListener("click", e => {

                e.preventDefault();
                DeleteDocument(item.id);
            });
            linksTd.setAttribute("class", "table__seconditem table__row");
            linksTd.append(removeLink);
            tr.appendChild(linksTd);

            return tr;
        }



        function addErrors(errors) { //Функция добавляет в строку ошибки лист ошибок которые были допущены
            errors.forEach(error => {
                const p = document.createElement("p");
                p.append(error);
                document.getElementById("errors").append(p);
            });
        }

        function addError(errors) { //Функция добавление одной ошибки
            document.getElementById("errors").innerHTML = '';
            document.getElementById("errors").append(errors);
            document.getElementById("errors").style.display = "block";
        }




        document.getElementById("reset").onclick = function (e) { //Ищет кнопку обновление и при клике запускает функцию обновление формы

            e.preventDefault();
            reset();
        };

        document.forms["userForm"].addEventListener("submit", e => { //Создаем ивент для кнопки сохранить и пишем для нее фунцию сохранения
            e.preventDefault();
            const form = document.forms["userForm"]; //Получаем форму
            const id = form.elements["id"].value; //Получаем айди значение id(Если мы собираемся изменить файл, то оно не будет равно 0)
            const title = form.elements["name"].value; //Получаем название файла
            //var myfile = form.elements["uploadedFile"].files; //Получаем фалй который внес модератор
            var data = new FormData(); //Создаем класс в который занесутся все данные об файле

            //if (myfile.length > 0) { //Если размер файла больше 0
            //    for (var i = 0; i < myfile.length; i++) {
            //        data.append('uploadedFile', myfile[i]); //Добавляем все файлы в список для файлом
            //    }
            //}
            var result = myEditor.getData({ pagination: true });


            data.append('uploadedFile', result);
            data.append('Title', title); //Добавляем название файла
            data.append('IdCategory', categoryId); //Добавляем id категории в которую занесется файл


            //const templates = []; //Создаем пустой лист для шаблонов

            //var l = document.querySelector("abody").children;
            //for (let i = 0; i < l.length; i++) {
            //    if (l[i].type == "checkbox") {
            //        if (l[i].checked)
            //            templates.push(l[i].id); //добавляем в лист те шаблоны которые помечены модератором
            //    }
            //}
            //data.append('Templates', templates); //Добавляем лист шаблонов в класс для хранения

            if (title == "") { //TODO: Сделать красивые ошибки
                addError("Пустой Title") //Если название пусто то отобразит ошибку
            }
            //else if (myfile.length == 0) {
            //    addError("Не выбран файл") //Если количество файло равно 0 то отобразит ошибку
            //}
            else {

                if (id == 0) //Если id равно 0 то создаем новый файл в бд
                    CreateDocument(data);
                else {
                    data.append('Id', id); //Если id чему то равно то добавляем id в класс для хранения
                    EditDocument(data); //Изменяем файл к бд
                }
            }
        });




        CheckAuthorizeRole(); //Проверяем авторизацию

        var categoryId = window.location.href.split("?")[1].split("=")[1]; //Получаем id категории

        GetDocuments(); //Вызываем функцию для получения списков документов
        GetTemplates(); //Вызываем функцию для получения списка шаблонов


    </script>
</body>
</html>