<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!--<meta charset="utf-8">-->
    <title>Download</title>
    <link href="../css/style.css" rel="stylesheet" />
</head>
<body>
    <header class="header">
        <nav class="top-menu">
            <ul class="menu-main">
                <li><a href="/index.html">Главная</a></li>
                <li><a href="/Page/PersonalAccount.html">Личный Кабинет</a></li>
                <li><a href="#">FAQ</a></li>
            </ul>
        </nav>

        <center>
            <button id="back" class="backbtn">
                Назад
            </button>
        </center>

        <div class="file__item">
            <iframe id="iframe" width=600 height=700 > </iframe>
        </div>



        <ul class="download__bottonlist">
            <li class="download__item">
                <button id="download" class="downloadbtn">
                    Скачать
                </button>
            </li>


        </ul>
    </header>

    <script src="../js/Main.js"></script>
    <script>

        async function Download(id) { //Пост запрос для скачивания файла


            const response = await fetch("/document", { //Отправляем пост запрос в контроллер /document
                method: "POST", //То что это пост запрос
                headers: { "Accept": "application/json", "Content-Type": "application/json" }, //Передается и принимается только json файл
                body: JSON.stringify({ //В ввиде json отправляем id
                    id: id
                })
            });
            if (response.ok === true) { //Если приходит результат выполнено успешно
                const file = await response.blob(); //приравниваем к переменной файл

                const url = URL.createObjectURL(file); //Получаем ссылку к файлу
                const a = document.createElement('a'); //Создаем пустой элемент <a>

                const filename = url.split("/")[3]; //Получаем название файла

                a.href = url; //К <a href> ставим ссылку на скачивание файла
                a.download = title + '.pdf' || 'download'; //При скачивание файла через элемент <a> название файла будет filename + '.pdf'

                const clickHandler = () => { //Создаем Ивент для удаления файла после скачивания
                    setTimeout(() => { //Временная пауза перед удалением
                        URL.revokeObjectURL(url); //Удаляем ссылку
                        this.removeEventListener('click', clickHandler); //Удаляем ивент
                    }, 150); //150 - время для ожидания
                };

                a.addEventListener('click', clickHandler, false); //Добавляем ивент при клике <a>
                a.click(); //Имитируем клик, то есть <a> нажимается
                return a;
            }
        }



        async function Bottons(id) { //Функция создает кнопки и настраивает их
            const response = await fetch("/document/item/" + id, { //Получаем запросом информацию об файле который открыли
                method: "GET",
                headers: { "Accept": "application/json", "Content-Type": "application/json" },
            });
            if (response.ok === true) {
                const item = await response.json();
                let back = document.getElementById("back"); //Находим кнопку для переходим назад
                back.onclick = function () { document.location.href = document.referrer; }; //При нажатии кнопки переходит на прошлую страницу

                let download = document.getElementById("download"); //Находит кнопку для скачивания
                download.onclick = function () { Download(id); }; //При нажатии сработает функция скачивания



                let iframe = document.getElementById("iframe"); //Находим панель для отображения файла //TODO: кодировка
                iframe.setAttribute("src", item.pathPDF.split("wwwroot")[1]); //Устанавливаем ссылку на файл чтобы отобразить его
                title = item.title
            }
        }
        var paramValue = window.location.href.split("?")[1].split("=")[1]; //Получаем id файла для его поиска
        var title;
        CheckAuthorize(); //Проверяем авторизацию
        Bottons(paramValue); //Вызываем настройку кнопок

    </script>
</body>
</html>